create or replace function nieuwkoersinfo(name varchar,datstr varchar,vol int4,"open" double precision,high double precision,low double precision,"last" double precision) returns setof koers as $$
declare
  koersrij koers%ROWTYPE;
  transrij rektrans%ROWTYPE;
  rawrij koersid%ROWTYPE;
begin

  koersrij.naam:=name;
  koersrij.datum:=datstr;
  koersrij.volume:=vol;
  koersrij.hoog:=high;
  koersrij.laag=low;
  koersrij.slot:="last";
  koersrij."open":="open";

  return next koersrij;

  select * into transrij from rektrans where naam=name;
  if not found then
    INSERT INTO rekening (naam) VALUES (name);
    select * into transrij from rektrans where naam=name;
  end if;

  select * into rawrij from koersid where id=transrij.id and datum=date(datstr);
  if not found then
      INSERT INTO koers (naam,datum,volume,open,hoog,laag,slot) VALUES(name,date(datstr),vol,"open",high,low,"last");
  else
    koersrij."open" = rawrij."open";
    if (low < rawrij.laag) then 
      koersrij.laag:=low;
    end if;
    if (high > rawrij.hoog) then
      koersrij.hoog:=high;
    end if;
    if (vol >rawrij.volume) then 
      koersrij.volume:=vol;
    end if;
    koersrij.slot:="last";
    update koersid set volume=koersrij.volume,laag=koersrij.laag,hoog=koersrij.hoog,slot=koersrij.slot where id=transrij.id and datum=date(datstr);
  end if;

  return next koersrij;

  return;
end;
$$ language plpgsql;
